name: CI/CD

on:
  push:
    branches: ['**']
  pull_request:
    branches: [ Main ]
  workflow_dispatch:

jobs:
  quality-control:
    name: Quality Control
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.format.outcome }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
          dotnet-quality: 'preview'

      - name: Format Check
        id: format
        run: |
          dotnet format CQRS-Synchronisation.sln --verify-no-changes --verbosity diagnostic

  testing:
    name: Testing
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.test.outcome }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
          dotnet-quality: 'preview'

      - name: Run Tests
        id: test
        run: |
          dotnet test test/ApplicationTests/ApplicationTests.csproj --configuration Release

  integration:
    name: Integration
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.integration_test.outcome }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
          dotnet-quality: 'preview'

      - name: Start Infrastructure
        run: |
          docker compose -f test/IntegrationTests/config/docker-compose.yml up -d --wait

      - name: Run Integration Tests
        id: integration_test
        run: |
          dotnet test test/IntegrationTests/IntegrationTests.csproj --configuration Release

      - name: Stop Infrastructure
        if: always()
        run: |
          docker compose -f test/IntegrationTests/config/docker-compose.yml down

  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.enforce.outcome }}
      percentage: ${{ steps.enforce.outputs.percentage }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
          dotnet-quality: 'preview'

      - name: Collect Coverage
        id: collect
        run: |
          dotnet test test/ApplicationTests/ApplicationTests.csproj \
            --configuration Release \
            --collect:"XPlat Code Coverage" \
            -- \
            DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Include="[Application]*"

      - name: Enforce 80% Threshold
        id: enforce
        run: |
          COVERAGE_FILE=$(find test/ApplicationTests/TestResults -name "*.xml" | head -n 1)
          
          if [ -z "$COVERAGE_FILE" ]; then
            echo "❌ No coverage XML found! Tests likely failed or did not generate report."
            echo "percentage=0.00" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "Found coverage file at: $COVERAGE_FILE"
          
          COVERAGE_RATE=$(grep -o 'line-rate="[0-9.]*"' "$COVERAGE_FILE" | head -1 | grep -o '[0-9.]*')
          if [ -z "$COVERAGE_RATE" ]; then COVERAGE_RATE=0; fi
          
          COVERAGE_PCT=$(awk "BEGIN {printf \"%.2f\", $COVERAGE_RATE * 100}")
          
          echo "Current Coverage: $COVERAGE_PCT%"
          echo "percentage=$COVERAGE_PCT" >> $GITHUB_OUTPUT
          
          if (( $(echo "$COVERAGE_PCT < 80.00" | bc -l) )); then
            echo "❌ Code coverage is below 80%."
            exit 1
          else
            echo "✅ Code coverage meets the threshold."
          fi
        shell: bash
  
  build:
    name: Build
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.build.outcome }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Docker Build
        id: build
        run: |
          dotnet publish src/Main/Main.csproj --os linux --arch x64 /t:PublishContainer
