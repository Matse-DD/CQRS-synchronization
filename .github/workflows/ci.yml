name: CI/CD

on:
  push:
    branches: ['**']
  pull_request:
    branches: [ Main ]
  workflow_dispatch:

jobs:
  quality-control:
    name: Quality Control
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.format.outcome }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
          dotnet-quality: 'preview'

      - name: Format Check
        id: format
        run: |
          dotnet format CQRS-Synchronisation.sln --verify-no-changes --verbosity diagnostic

  testing:
    name: Testing
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.test.outcome }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
          dotnet-quality: 'preview'

      - name: Run Tests
        id: test
        run: |
          dotnet test test/ApplicationTests/ApplicationTests.csproj --configuration Release

    integration:
    name: Integration
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.integration_test.outcome }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
          dotnet-quality: 'preview'

      - name: Start Infrastructure
        run: |
          docker compose -f test/IntegrationTests/config/docker-compose.yml up -d --wait

      - name: Run Integration Tests
        id: integration_test
        run: |
          dotnet test test/IntegrationTests/IntegrationTests.csproj --configuration Release

      - name: Stop Infrastructure
        if: always()
        run: |
          docker compose -f test/IntegrationTests/config/docker-compose.yml down

  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.enforce.outcome }}
      percentage: ${{ steps.enforce.outputs.percentage }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
          dotnet-quality: 'preview'

      - name: Install Dotnet Coverage
        run: dotnet tool install --global dotnet-coverage

      - name: Collect Coverage
        id: collect
        run: |
          dotnet-coverage collect "dotnet test test/ApplicationTests/ApplicationTests.csproj --configuration Release" \
            -f cobertura \
            -o coverage.xml \
            --include-files "**/Application.dll"

      - name: Enforce 80% Threshold
        id: enforce
        run: |
          if [ ! -f coverage.xml ]; then
            echo "❌ No coverage.xml found! Tests likely failed."
            echo "percentage=0.00" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          COVERAGE_RATE=$(grep -o 'line-rate="[0-9.]*"' coverage.xml | head -1 | grep -o '[0-9.]*')
          if [ -z "$COVERAGE_RATE" ]; then COVERAGE_RATE=0; fi

          COVERAGE_PCT=$(awk "BEGIN {printf \"%.2f\", $COVERAGE_RATE * 100}")
          
          echo "Current Coverage: $COVERAGE_PCT%"
          echo "percentage=$COVERAGE_PCT" >> $GITHUB_OUTPUT

          if (( $(echo "$COVERAGE_PCT < 80.00" | bc -l) )); then
            echo "❌ Code coverage is below 80%."
            exit 1
          else
            echo "✅ Code coverage meets the threshold."
          fi
        shell: bash
  
  build:
    name: Build
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.build.outcome }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Docker Build
        id: build
        run: |
          dotnet publish src/Main/Main.csproj --os linux --arch x64 /t:PublishContainer

  discord:
    name: Discord
    runs-on: ubuntu-latest
    needs: [ quality-control, testing, integration, coverage, build ]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine Pipeline Status
        id: status
        run: |
          OVERALL="Passed"
          COLOR=3066993
          
          if [ "${{ needs.quality-control.outputs.status }}" != "success" ] || \
             [ "${{ needs.testing.outputs.status }}" != "success" ] || \
             [ "${{ needs.integration.outputs.status }}" != "success" ] || \
             [ "${{ needs.coverage.outputs.status }}" != "success" ] || \
             [ "${{ needs.build.outputs.status }}" != "success" ]; then
            OVERALL="Failed"
            COLOR=15158332
          fi
          
          echo "overall=$OVERALL" >> $GITHUB_OUTPUT
          echo "color=$COLOR" >> $GITHUB_OUTPUT
          
          get_icon() {
            if [ "$1" == "success" ]; then echo "✅";
            else echo "❌"; fi
          }
          
          get_text() {
             if [ "$1" == "success" ]; then echo "Passed";
             else echo "Failed"; fi
          }
          
          COV_STATUS="${{ needs.coverage.outputs.status }}"
          COV_PCT="${{ needs.coverage.outputs.percentage }}"
          
          if [ -z "$COV_PCT" ]; then COV_PCT="0.00"; fi
          
          if [ "$COV_STATUS" == "success" ]; then
             COV_MSG="✅ Coverage - Passed ($COV_PCT%)"
          else
             COV_MSG="❌ Coverage - Failed ($COV_PCT% < 80%)"
          fi
          
          QC="${{ needs.quality-control.outputs.status }}"
          TEST="${{ needs.testing.outputs.status }}"
          INT="${{ needs.integration.outputs.status }}"
          BUILD="${{ needs.build.outputs.status }}"
          
          echo "format_result=$(get_icon $QC) Quality Control - $(get_text $QC)" >> $GITHUB_OUTPUT
          echo "test_result=$(get_icon $TEST) Testing - $(get_text $TEST)" >> $GITHUB_OUTPUT
          echo "integration_result=$(get_icon $INT) Integration - $(get_text $INT)" >> $GITHUB_OUTPUT
          echo "coverage_result=$COV_MSG" >> $GITHUB_OUTPUT
          echo "build_result=$(get_icon $BUILD) Build - $(get_text $BUILD)" >> $GITHUB_OUTPUT

      - name: Get Commit Messages
        id: commits
        run: |
          TOTAL_COMMITS=$(git rev-list --count ${{ github.event.before }}..${{ github.sha }} 2>/dev/null || echo "1")
          COMMITS=$(git log --format="%h - %s" -n 10 ${{ github.event.before }}..${{ github.sha }} 2>/dev/null || git log --format="%h - %s" -n 10 -1)
          FORMATTED_COMMITS=$(echo "$COMMITS" | sed 's/^\([^ ]*\) - /`\1` - /')
          
          if [ "$TOTAL_COMMITS" -gt 10 ]; then
            REMAINING=$((TOTAL_COMMITS - 10))
            FORMATTED_COMMITS="$FORMATTED_COMMITS"$'\n'"and $REMAINING more commit(s)..."
          fi
          
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$FORMATTED_COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Get Timestamp
        id: timestamp
        run: echo "time=$(date +'%d/%m/%Y, %H:%M')" >> $GITHUB_OUTPUT

      - name: Send Webhook
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          embed-title: "CI/CD Pipeline: ${{ steps.status.outputs.overall }}"
          embed-description: |
            **Repository:** ${{ github.repository }}
            **Branch:** ${{ github.ref_name }}
            
            **Commits:**
            ${{ steps.commits.outputs.commits }}
            
            **Pipeline Results:**
            ${{ steps.status.outputs.format_result }}
            ${{ steps.status.outputs.test_result }}
            ${{ steps.status.outputs.integration_result }}
            ${{ steps.status.outputs.coverage_result }}
            ${{ steps.status.outputs.build_result }}
          embed-footer-text: Triggered by ${{ github.actor }} • ${{ steps.timestamp.outputs.time }}
          embed-color: ${{ steps.status.outputs.color }}